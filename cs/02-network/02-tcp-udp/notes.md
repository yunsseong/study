# TCP & UDP

## TCP (Transmission Control Protocol)

### 특징
- **연결 지향**: 통신 전에 연결 수립 필요
- **신뢰성 보장**: 데이터 손실 시 재전송
- **순서 보장**: 데이터가 보낸 순서대로 도착
- **흐름 제어 / 혼잡 제어**: 네트워크 상태에 맞춰 전송량 조절

---

### 3-Way Handshake (연결 수립)

```
Client                    Server
  |                         |
  |--- SYN (seq=100) ---→  |   ① 클라이언트: "연결하고 싶어" (SYN)
  |                         |
  |←- SYN+ACK (seq=200,    |   ② 서버: "OK, 나도 연결하자" (SYN+ACK)
  |    ack=101) ----------  |
  |                         |
  |--- ACK (ack=201) ---→  |   ③ 클라이언트: "확인!" (ACK)
  |                         |
  |===== 연결 완료 =========|
```

**왜 3번인가?** (면접 빈출)
- 2번이면? → 서버가 보낸 SYN을 클라이언트가 받았는지 서버가 확인 불가
- 양쪽 모두 **송신/수신 능력을 검증**하려면 최소 3번 필요

---

### 4-Way Handshake (연결 해제)

```
Client                    Server
  |                         |
  |--- FIN (seq=100) ---→  |   ① 클라이언트: "연결 끊을게" (FIN)
  |                         |
  |←-- ACK (ack=101) ----  |   ② 서버: "알겠어, 잠깐만" (ACK)
  |                         |      (서버가 남은 데이터 전송)
  |←-- FIN (seq=200) ----  |   ③ 서버: "나도 준비 됐어" (FIN)
  |                         |
  |--- ACK (ack=201) ---→  |   ④ 클라이언트: "확인!" (ACK)
  |                         |
  |=== TIME_WAIT =========→|   (일정 시간 대기 후 종료)
```

**왜 4번인가?**
- 서버가 FIN을 받아도 보내야 할 데이터가 남아있을 수 있음
- ACK와 FIN을 분리해서 보냄 (3-way에서는 SYN+ACK를 합침)

**TIME_WAIT은 왜 필요한가?** (면접 빈출)
- 마지막 ACK가 유실될 경우 서버가 FIN을 재전송 → 이를 처리하기 위해 대기
- 이전 연결의 패킷이 새 연결에 영향을 주지 않도록 보장

---

### TCP 헤더 구조 (주요 필드)

| 필드 | 크기 | 역할 |
|------|------|------|
| Source Port | 16bit | 출발지 포트 |
| Destination Port | 16bit | 목적지 포트 |
| Sequence Number | 32bit | 데이터 순서 번호 |
| Acknowledgment Number | 32bit | 수신 확인 번호 |
| Flags | 6bit | SYN, ACK, FIN, RST 등 |
| Window Size | 16bit | 수신 가능한 버퍼 크기 |
| Checksum | 16bit | 오류 검출 |

---

### 흐름 제어 (Flow Control)

**수신 측**의 처리 속도에 맞춰 전송 속도를 조절.

#### 슬라이딩 윈도우

```
전송 가능 윈도우 (Window Size = 4)
[1][2][3][4] [5][6][7][8]...
 ↑ 전송 완료  ↑ 전송 가능  ↑ 아직 전송 불가

ACK 2 수신 → 윈도우 이동
   [2][3][4][5] [6][7][8]...
```

- 수신 측이 Window Size를 통해 "나 이만큼 받을 수 있어"를 알림
- 송신 측은 ACK 없이도 윈도우 크기만큼 연속 전송 가능
- ACK를 받으면 윈도우가 오른쪽으로 슬라이드

---

### 혼잡 제어 (Congestion Control)

**네트워크**의 혼잡 상태에 맞춰 전송 속도를 조절.

| 알고리즘 | 동작 |
|---------|------|
| Slow Start | 1부터 시작, 지수적 증가 (1→2→4→8) |
| Congestion Avoidance | 임계값 이후 선형적 증가 (8→9→10→11) |
| Fast Retransmit | 중복 ACK 3개 → 타임아웃 안 기다리고 즉시 재전송 |
| Fast Recovery | 재전송 후 Slow Start 대신 절반에서 선형 증가 |

```
전송량
  ↑
  |        /\
  |       /  \     /
  |      /    \   /
  |     /      \/     ← 패킷 손실 감지 → 절반으로 줄임
  |    /
  |   /    ← Slow Start (지수적 증가)
  |  /
  | /
  +──────────────→ 시간
       ↑
    임계값 (Congestion Avoidance 전환)
```

---

### 흐름 제어 vs 혼잡 제어

| 비교 | 흐름 제어 | 혼잡 제어 |
|------|----------|----------|
| 대상 | 수신자 | 네트워크 |
| 문제 | 수신자 버퍼 오버플로우 | 네트워크 과부하 |
| 방법 | Window Size 조절 | Slow Start, AIMD |
| 주체 | 송신자 ↔ 수신자 | 송신자 ↔ 네트워크 |

---

## UDP (User Datagram Protocol)

### 특징
- **비연결**: handshake 없이 바로 전송
- **비신뢰성**: 데이터 손실 감수, 재전송 없음
- **순서 미보장**: 도착 순서 보장 안 함
- **빠름**: 오버헤드가 적어 속도가 빠름
- **헤더가 단순**: 8바이트 (TCP는 20바이트 이상)

### UDP 헤더

| 필드 | 크기 |
|------|------|
| Source Port | 16bit |
| Destination Port | 16bit |
| Length | 16bit |
| Checksum | 16bit |

> TCP 대비 매우 단순 → 빠름

---

## TCP vs UDP 비교 (면접 핵심)

| 비교 | TCP | UDP |
|------|-----|-----|
| 연결 방식 | 연결 지향 (3-way handshake) | 비연결 |
| 신뢰성 | 보장 (재전송) | 미보장 |
| 순서 보장 | O | X |
| 속도 | 느림 | 빠름 |
| 헤더 크기 | 20~60 바이트 | 8 바이트 |
| 전송 방식 | 스트림 (바이트 단위) | 데이터그램 (메시지 단위) |
| 흐름/혼잡 제어 | O | X |

### 각각 언제 사용하나?

| TCP | UDP |
|-----|-----|
| 웹 (HTTP/HTTPS) | 실시간 스트리밍 (영상, 음성) |
| 이메일 (SMTP) | 온라인 게임 |
| 파일 전송 (FTP) | DNS 조회 |
| 데이터베이스 연결 | IoT 센서 데이터 |
| SSH | VoIP (인터넷 전화) |

> **판단 기준**: "데이터 하나라도 잃으면 안 되나?" → TCP, "속도가 더 중요한가?" → UDP

---

## 심화: TCP 재전송 메커니즘

### 타임아웃 기반 재전송

```
Client → 패킷 1 전송 → 타이머 시작
         ACK 안 옴... (타임아웃)
Client → 패킷 1 재전송
         ← ACK 수신 → 성공
```

### Fast Retransmit

```
Client → 패킷 1, 2, 3, 4, 5 전송
Server → ACK 1 (패킷 1 수신)
Server → ACK 2 (패킷 2 수신)
Server → ACK 2 (패킷 3 유실! 여전히 2 요청)  ← 중복 ACK 1
Server → ACK 2 (패킷 4 수신, 여전히 2 요청)  ← 중복 ACK 2
Server → ACK 2 (패킷 5 수신, 여전히 2 요청)  ← 중복 ACK 3
Client → 중복 ACK 3개 감지 → 패킷 3 즉시 재전송 (타임아웃 안 기다림)
```

---

## 면접 예상 질문

1. **TCP 3-way handshake를 설명해주세요**
   - SYN → SYN+ACK → ACK, 양쪽 송수신 능력 검증

2. **왜 3-way이지 2-way가 아닌가요?**
   - 양쪽 모두 송신/수신 능력을 확인하려면 최소 3번 필요

3. **TCP와 UDP의 차이점은?**
   - 연결/비연결, 신뢰성, 순서, 속도 비교

4. **TIME_WAIT 상태란?**
   - 연결 종료 후 대기, ACK 유실 대비 + 이전 패킷 보호

5. **흐름 제어와 혼잡 제어의 차이는?**
   - 수신자 보호 vs 네트워크 보호

6. **TCP가 신뢰성을 보장하는 방법은?**
   - 순서 번호, ACK, 재전송, 체크섬
