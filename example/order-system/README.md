# ì£¼ë¬¸/ê²°ì œ ì‹œìŠ¤í…œ (Order System)

## ğŸ“‹ í”„ë¡œì íŠ¸ ì†Œê°œ

Spring Boot ê¸°ë°˜ì˜ ì£¼ë¬¸/ê²°ì œ ì‹œìŠ¤í…œ í•™ìŠµ í”„ë¡œì íŠ¸ì…ë‹ˆë‹¤.
ì‹¤ë¬´ì—ì„œ ìì£¼ ë§ˆì£¼ì¹˜ëŠ” **ë™ì‹œì„± ì œì–´**, **ë©±ë“±ì„±**, **ìƒíƒœ ê´€ë¦¬**, **ì´ë²¤íŠ¸ ê¸°ë°˜ ì•„í‚¤í…ì²˜** ë“±ì˜ í•µì‹¬ íŒ¨í„´ì„ í•™ìŠµí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì´ í”„ë¡œì íŠ¸ëŠ” ì‹¤ì œ ì´ì»¤ë¨¸ìŠ¤ ì„œë¹„ìŠ¤ì˜ í•µì‹¬ ê¸°ëŠ¥ì„ ë‹¨ìˆœí™”í•˜ì—¬ êµ¬í˜„í•˜ì˜€ìœ¼ë©°, ê° íŒ¨í„´ì˜ **ì™œ(Why)**ì™€ **ì–´ë–»ê²Œ(How)**ë¥¼ ëª…í™•íˆ ì´í•´í•˜ëŠ” ê²ƒì„ ëª©í‘œë¡œ í•©ë‹ˆë‹¤.

## ğŸ›  ê¸°ìˆ  ìŠ¤íƒ

| ì¹´í…Œê³ ë¦¬ | ê¸°ìˆ  |
|---------|------|
| Framework | Spring Boot 3.2 |
| ORM | Spring Data JPA |
| Database | H2 (dev), MySQL (prod) |
| Build Tool | Gradle |
| Language | Java 17 |
| Test | JUnit 5, AssertJ |

## ğŸ¯ í•µì‹¬ í•™ìŠµ í¬ì¸íŠ¸

### 1. ë‚™ê´€ì  ë½ (Optimistic Lock) - ì¬ê³  ê´€ë¦¬

#### ê°œë…
ë‚™ê´€ì  ë½ì€ "ì¶©ëŒì´ ìì£¼ ì¼ì–´ë‚˜ì§€ ì•Šì„ ê²ƒ"ì´ë¼ê³  **ë‚™ê´€ì ìœ¼ë¡œ ê°€ì •**í•˜ê³ , ë°ì´í„°ë¥¼ ì½ì„ ë•ŒëŠ” ë½ì„ ê±¸ì§€ ì•ŠìŠµë‹ˆë‹¤.
ëŒ€ì‹  **ìˆ˜ì • ì‹œì ì— ë²„ì „ì„ í™•ì¸**í•˜ì—¬ ë‹¤ë¥¸ íŠ¸ëœì­ì…˜ì´ ë¨¼ì € ìˆ˜ì •í–ˆëŠ”ì§€ ê²€ì¦í•©ë‹ˆë‹¤.

#### ë™ì‘ ì›ë¦¬
```
@Version í•„ë“œë¥¼ ì‚¬ìš©í•œ ë™ì‹œì„± ì œì–´

1. íŠ¸ëœì­ì…˜ A: Product ì¡°íšŒ (stock=100, version=1)
2. íŠ¸ëœì­ì…˜ B: Product ì¡°íšŒ (stock=100, version=1)
3. íŠ¸ëœì­ì…˜ A: UPDATE ... SET stock=90, version=2 WHERE id=? AND version=1 âœ… ì„±ê³µ
4. íŠ¸ëœì­ì…˜ B: UPDATE ... SET stock=90, version=2 WHERE id=? AND version=1 âŒ ì‹¤íŒ¨
   â†’ version=2ë¡œ ì´ë¯¸ ë³€ê²½ë˜ì–´ WHERE ì¡°ê±´ ë¶ˆì¼ì¹˜
   â†’ OptimisticLockingFailureException ë°œìƒ
```

#### ë¹„ê´€ì  ë½ê³¼ì˜ ë¹„êµ

| í•­ëª© | ë‚™ê´€ì  ë½ (Optimistic) | ë¹„ê´€ì  ë½ (Pessimistic) |
|------|----------------------|------------------------|
| **ë½ ì‹œì ** | ìˆ˜ì • ì‹œ (ì»¤ë°‹ ì‹œì ) | ì½ê¸° ì‹œ (SELECT ì‹œì ) |
| **ë½ ë°©ì‹** | ë²„ì „ ì²´í¬ (@Version) | DB ë½ (SELECT FOR UPDATE) |
| **ì„±ëŠ¥** | ì½ê¸° ì„±ëŠ¥ ì¢‹ìŒ | ë™ì‹œì„± ë‚®ì„ ë•Œ ì„±ëŠ¥ ì €í•˜ |
| **ì¶©ëŒ ì²˜ë¦¬** | ì˜ˆì™¸ ë°œìƒ â†’ ì¬ì‹œë„ í•„ìš” | ë½ ëŒ€ê¸° â†’ ìˆœì°¨ ì²˜ë¦¬ |
| **ì í•©í•œ ìƒí™©** | ì¶©ëŒ ì ìŒ (ì¼ë°˜ ì‡¼í•‘ëª°) | ì¶©ëŒ ë§ìŒ (ì„ ì°©ìˆœ ì¿ í°) |
| **ì‹¤ë¬´ ì‚¬ë¡€** | ì¼ë°˜ ìƒí’ˆ ì¬ê³  ê´€ë¦¬ | í‹°ì¼“íŒ…, í•œì • ìˆ˜ëŸ‰ ì´ë²¤íŠ¸ |

#### ASCII Diagram
```
[ë‚™ê´€ì  ë½ - ì¼ë¶€ ìš”ì²­ ì‹¤íŒ¨]
Thread-1 â”€â”€â”
Thread-2 â”€â”€â”¼â”€â”€> Product (version=1)
Thread-3 â”€â”€â”˜

  â†“ (ë™ì‹œ ì¬ê³  ì°¨ê° ì‹œë„)

Thread-1: UPDATE version=2 âœ… ì„±ê³µ
Thread-2: UPDATE version=2 âŒ ì‹¤íŒ¨ (version ë¶ˆì¼ì¹˜)
Thread-3: UPDATE version=2 âŒ ì‹¤íŒ¨ (version ë¶ˆì¼ì¹˜)

â†’ ì‹¤íŒ¨í•œ ìš”ì²­ì€ ì¬ì‹œë„ ë¡œì§ í•„ìš”


[ë¹„ê´€ì  ë½ - ëª¨ë“  ìš”ì²­ ì„±ê³µ]
Thread-1 â”€â”€> SELECT FOR UPDATE (ë½ íšë“) âœ…
Thread-2 â”€â”€> ëŒ€ê¸°... â³
Thread-3 â”€â”€> ëŒ€ê¸°... â³

Thread-1 ì™„ë£Œ â†’ Thread-2 ë½ íšë“ âœ…
Thread-2 ì™„ë£Œ â†’ Thread-3 ë½ íšë“ âœ…

â†’ ëª¨ë“  ìš”ì²­ ìˆœì°¨ ì²˜ë¦¬ (100% ì„±ê³µ)
```

#### ì–¸ì œ ì‚¬ìš©í• ê¹Œ?
- âœ… **ë‚™ê´€ì  ë½ ì‚¬ìš©**: ì¼ë°˜ ì‡¼í•‘ëª° ìƒí’ˆ ì¬ê³  (ì¶©ëŒ ì ìŒ)
- âœ… **ë¹„ê´€ì  ë½ ì‚¬ìš©**: ì„ ì°©ìˆœ ì¿ í°, í‹°ì¼“íŒ… (ì¶©ëŒ ë§ìŒ, 100% ì„±ê³µ í•„ìš”)

---

### 2. ì£¼ë¬¸ ìƒíƒœ ë¨¸ì‹  (State Machine)

#### ê°œë…
ì£¼ë¬¸ì€ ì—¬ëŸ¬ ìƒíƒœë¥¼ ê±°ì¹˜ë©°, **í—ˆìš©ëœ ìƒíƒœ ì „ì´ë§Œ ê°€ëŠ¥**í•©ë‹ˆë‹¤.
ì´ë¥¼ **ìƒíƒœ ë¨¸ì‹ (State Machine)** íŒ¨í„´ìœ¼ë¡œ ê´€ë¦¬í•˜ì—¬ ì˜ëª»ëœ ìƒíƒœ ë³€ê²½ì„ ë°©ì§€í•©ë‹ˆë‹¤.

#### ìƒíƒœ ì „ì´ ë‹¤ì´ì–´ê·¸ë¨
```
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚   CREATED   â”‚ (ì£¼ë¬¸ ìƒì„±)
                   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                    pay() â”‚
                          â†“
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”Œâ”€â”€â”€â”€â”‚    PAID     â”‚ (ê²°ì œ ì™„ë£Œ)
              â”‚    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
              â”‚           â”‚
        cancel()â”‚   ship()â”‚
              â”‚           â†“
              â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚    â”‚   SHIPPED   â”‚ (ë°°ì†¡ ì¤‘)
              â”‚    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
              â”‚           â”‚
              â”‚   deliver()â”‚
              â”‚           â†“
              â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚    â”‚  DELIVERED  â”‚ (ë°°ì†¡ ì™„ë£Œ)
              â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â†“
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚  CANCELLED  â”‚ (ì£¼ë¬¸ ì·¨ì†Œ)
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### í—ˆìš©ëœ ì „ì´
```java
CREATED  â†’ PAID       âœ… order.pay()
PAID     â†’ SHIPPED    âœ… order.ship()
SHIPPED  â†’ DELIVERED  âœ… order.deliver()
CREATED  â†’ CANCELLED  âœ… order.cancel()
PAID     â†’ CANCELLED  âœ… order.cancel() (í™˜ë¶ˆ í•„ìš”)
```

#### í—ˆìš©ë˜ì§€ ì•ŠëŠ” ì „ì´ (ì˜ˆì™¸ ë°œìƒ)
```java
CREATED   â†’ SHIPPED    âŒ ê²°ì œ ì—†ì´ ë°°ì†¡ ë¶ˆê°€
DELIVERED â†’ CANCELLED  âŒ ë°°ì†¡ ì™„ë£Œ í›„ ì·¨ì†Œ ë¶ˆê°€
CANCELLED â†’ PAID       âŒ ì·¨ì†Œëœ ì£¼ë¬¸ ê²°ì œ ë¶ˆê°€
SHIPPED   â†’ CREATED    âŒ ì—­ë°©í–¥ ì „ì´ ë¶ˆê°€
```

#### ì½”ë“œ êµ¬í˜„
```java
public enum OrderStatus {
    CREATED, PAID, SHIPPED, DELIVERED, CANCELLED;

    public boolean canPay() {
        return this == CREATED;  // CREATED ìƒíƒœë§Œ ê²°ì œ ê°€ëŠ¥
    }

    public boolean canCancel() {
        return this == CREATED || this == PAID;  // ë°°ì†¡ ì „ê¹Œì§€ë§Œ ì·¨ì†Œ ê°€ëŠ¥
    }

    public boolean canShip() {
        return this == PAID;  // ê²°ì œ ì™„ë£Œ í›„ì—ë§Œ ë°°ì†¡ ê°€ëŠ¥
    }
}
```

---

### 3. ë©±ë“±ì„± í‚¤ (Idempotency Key) - ê²°ì œ

#### ê°œë…
**ë©±ë“±ì„±(Idempotency)**: ê°™ì€ ìš”ì²­ì„ ì—¬ëŸ¬ ë²ˆ í•´ë„ ê²°ê³¼ê°€ ë™ì¼í•œ ì„±ì§ˆ

ê²°ì œëŠ” **ì ˆëŒ€ ì¤‘ë³µë˜ë©´ ì•ˆ ë˜ëŠ” ì‘ì—…**ì…ë‹ˆë‹¤.
ë„¤íŠ¸ì›Œí¬ íƒ€ì„ì•„ì›ƒì´ë‚˜ ì¬ì‹œë„ë¡œ ì¸í•œ ì¤‘ë³µ ê²°ì œë¥¼ ë°©ì§€í•˜ê¸° ìœ„í•´ **ë©±ë“±ì„± í‚¤**ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.

#### ë¬¸ì œ ìƒí™©
```
ğŸ“± ì‚¬ìš©ì: "ê²°ì œ" ë²„íŠ¼ í´ë¦­
    â†“
ğŸŒ ì„œë²„: ê²°ì œ ì²˜ë¦¬ ì¤‘... (PGì‚¬ API í˜¸ì¶œ)
    â†“
âŒ ë„¤íŠ¸ì›Œí¬ íƒ€ì„ì•„ì›ƒ! (ì‚¬ìš©ìëŠ” ì‘ë‹µì„ ëª» ë°›ìŒ)
    â†“
ğŸ“± ì‚¬ìš©ì: "ê²°ì œê°€ ì•ˆ ëë„¤?" â†’ ë‹¤ì‹œ í´ë¦­
    â†“
ğŸŒ ì„œë²„: ë˜ ê²°ì œ ì²˜ë¦¬???

â†’ ì¤‘ë³µ ê²°ì œ ë°œìƒ! ğŸ’¸ğŸ’¸
```

#### ë©±ë“±ì„± í‚¤ë¥¼ ì‚¬ìš©í•œ í•´ê²°
```
ìš”ì²­ 1: pay(orderId=100, amount=10000, idempotencyKey="abc123")
        â†’ ê²°ì œ ì²˜ë¦¬ âœ… Payment ID=1 ìƒì„±

ìš”ì²­ 2: pay(orderId=100, amount=10000, idempotencyKey="abc123")  # ê°™ì€ í‚¤!
        â†’ ì´ë¯¸ ì²˜ë¦¬ë¨ ë°œê²¬ âœ… Payment ID=1 ë°˜í™˜ (ìƒˆë¡œìš´ ê²°ì œ ìƒì„± X)

ìš”ì²­ 3: pay(orderId=100, amount=10000, idempotencyKey="xyz789")  # ë‹¤ë¥¸ í‚¤!
        â†’ ì´ë¯¸ ê²°ì œëœ ì£¼ë¬¸ âŒ ì˜ˆì™¸ ë°œìƒ
```

#### ë™ì‘ Flow
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. í´ë¼ì´ì–¸íŠ¸: ê²°ì œ ìš”ì²­ ìƒì„±                  â”‚
â”‚    - orderId: 100                           â”‚
â”‚    - amount: 10000                          â”‚
â”‚    - idempotencyKey: UUID.randomUUID()      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. ì„œë²„: DB ì¡°íšŒ                             â”‚
â”‚    SELECT * FROM payment                    â”‚
â”‚    WHERE idempotency_key = 'abc123'         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“                           â†“
    [ì¡´ì¬í•¨]                      [ì—†ìŒ]
         â†“                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ê¸°ì¡´ Payment    â”‚         â”‚ ìƒˆ Payment ìƒì„±   â”‚
â”‚ ë°˜í™˜ (ì¤‘ë³µ ë°©ì§€) â”‚         â”‚ idempotencyKey   â”‚
â”‚                â”‚         â”‚ ì €ì¥ (UNIQUE)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### ì‹¤ë¬´ ì‚¬ë¡€
| ì„œë¹„ìŠ¤ | ë©±ë“±ì„± í‚¤ êµ¬í˜„ ë°©ì‹ |
|-------|-------------------|
| **ì¹´ì¹´ì˜¤í˜ì´** | `partner_order_id` (ê°€ë§¹ì  ì£¼ë¬¸ ë²ˆí˜¸) |
| **í† ìŠ¤í˜ì´ë¨¼ì¸ ** | `orderId` + ê³ ìœ  í‚¤ ì¡°í•© |
| **ìŠ¤íŠ¸ë¼ì´í”„** | HTTP í—¤ë” `Idempotency-Key` |
| **í˜ì´íŒ”** | `invoice_id` (ì²­êµ¬ì„œ ë²ˆí˜¸) |

---

### 4. ì´ë²¤íŠ¸ ê¸°ë°˜ ì•„í‚¤í…ì²˜ (Event-Driven Architecture)

#### ê°œë…
ë„ë©”ì¸ ì´ë²¤íŠ¸ë¥¼ ë°œí–‰í•˜ì—¬ **ëŠìŠ¨í•œ ê²°í•©(Loose Coupling)**ì„ ìœ ì§€í•˜ê³ ,
ë¹„ë™ê¸° ì²˜ë¦¬ë‚˜ ì™¸ë¶€ ì‹œìŠ¤í…œ ì—°ë™ì„ ê¹”ë”í•˜ê²Œ ì²˜ë¦¬í•©ë‹ˆë‹¤.

#### ë™ì‘ ì›ë¦¬
```java
// ì£¼ë¬¸ ìƒì„± ì‹œ
@Transactional
public Order createOrder(...) {
    Order order = orderRepository.save(order);

    // ì´ë²¤íŠ¸ ë°œí–‰ (ë¹„ë™ê¸° ì²˜ë¦¬ìš©)
    eventPublisher.publishEvent(new OrderCreatedEvent(order.getId()));

    return order;
}

// ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
@EventListener
@Async  // ë¹„ë™ê¸° ì²˜ë¦¬
public void handleOrderCreated(OrderCreatedEvent event) {
    // ì´ë©”ì¼ ë°œì†¡
    emailService.sendOrderConfirmation(event.getOrderId());

    // ì•Œë¦¼ ë°œì†¡
    notificationService.sendPush(event.getOrderId());

    // ì¬ê³  ë¶„ì„ (ë³„ë„ ì‹œìŠ¤í…œ)
    analyticsService.trackOrder(event.getOrderId());
}
```

#### ì¥ì 
```
ê¸°ì¡´ ë°©ì‹ (ê°•í•œ ê²°í•©):
OrderService â”€â”€> EmailService
            â”€â”€> NotificationService
            â”€â”€> AnalyticsService

â†’ OrderServiceê°€ ëª¨ë“  ì˜ì¡´ì„±ì„ ì•Œì•„ì•¼ í•¨
â†’ ì„œë¹„ìŠ¤ ì¶”ê°€ ì‹œ OrderService ìˆ˜ì • í•„ìš”


ì´ë²¤íŠ¸ ë°©ì‹ (ëŠìŠ¨í•œ ê²°í•©):
OrderService â”€â”€> Event ë°œí–‰

Event â”€â”€> EmailService
      â”€â”€> NotificationService
      â”€â”€> AnalyticsService

â†’ OrderServiceëŠ” Eventë§Œ ë°œí–‰
â†’ ìƒˆë¡œìš´ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ ì‹œ OrderService ìˆ˜ì • ë¶ˆí•„ìš”
```

#### ë™ê¸° vs ë¹„ë™ê¸°
```java
// ë™ê¸° ì´ë²¤íŠ¸ (ê°™ì€ íŠ¸ëœì­ì…˜ ë‚´)
@EventListener
public void handleSync(OrderCreatedEvent event) {
    // ì£¼ë¬¸ ìƒì„± íŠ¸ëœì­ì…˜ ì•ˆì—ì„œ ì‹¤í–‰
    // ì‹¤íŒ¨ ì‹œ ì£¼ë¬¸ë„ ë¡¤ë°±
}

// ë¹„ë™ê¸° ì´ë²¤íŠ¸ (ë³„ë„ ìŠ¤ë ˆë“œ)
@EventListener
@Async
public void handleAsync(OrderCreatedEvent event) {
    // ë³„ë„ ìŠ¤ë ˆë“œì—ì„œ ì‹¤í–‰
    // ì‹¤íŒ¨í•´ë„ ì£¼ë¬¸ì€ ìœ ì§€
}
```

#### ì‹¤ë¬´ì—ì„œëŠ”?
- **ê°œë°œ í™˜ê²½**: Spring ApplicationEvent
- **ìš´ì˜ í™˜ê²½**: **Kafka**, **RabbitMQ**, **AWS SQS/SNS**
  - í™•ì¥ì„±, ë©”ì‹œì§€ ìˆœì„œ ë³´ì¥, ì¬ì²˜ë¦¬ ë“± í•„ìš”

---

### 5. ë³´ìƒ íŠ¸ëœì­ì…˜ (Compensation Transaction)

#### ê°œë…
ì´ë¯¸ ì‹¤í–‰ëœ ì‘ì—…ì„ **ë˜ëŒë¦¬ëŠ”** íŠ¸ëœì­ì…˜ì…ë‹ˆë‹¤.
ë¶„ì‚° ì‹œìŠ¤í…œì—ì„œëŠ” ì—¬ëŸ¬ ì„œë¹„ìŠ¤ì— ê±¸ì¹œ íŠ¸ëœì­ì…˜ì„ **Saga íŒ¨í„´**ìœ¼ë¡œ ê´€ë¦¬í•©ë‹ˆë‹¤.

#### ì˜ˆì‹œ: ì£¼ë¬¸ ì·¨ì†Œ
```
ì£¼ë¬¸ ìƒì„± ì‹œ:
1. ì£¼ë¬¸ ìƒì„±     âœ…
2. ì¬ê³  ì°¨ê°     âœ… (stock: 100 â†’ 80)
3. ê²°ì œ ì²˜ë¦¬     âœ…

ì£¼ë¬¸ ì·¨ì†Œ ì‹œ (ë³´ìƒ íŠ¸ëœì­ì…˜):
1. ì£¼ë¬¸ ì·¨ì†Œ     âœ… (status: PAID â†’ CANCELLED)
2. ì¬ê³  ë³µêµ¬     âœ… (stock: 80 â†’ 100)  â† ë³´ìƒ íŠ¸ëœì­ì…˜
3. ê²°ì œ í™˜ë¶ˆ     âœ…                    â† ë³´ìƒ íŠ¸ëœì­ì…˜
```

#### Saga íŒ¨í„´ (ë¶„ì‚° íŠ¸ëœì­ì…˜)
```
[Orchestration Saga - ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´í„°ê°€ ê´€ë¦¬]

OrderService â”€â”€â”
               â”œâ”€â”€> Saga Orchestrator
PaymentServiceâ”€â”¤         â”‚
               â”‚         â”œâ”€â”€> 1. createOrder()  âœ…
StockService â”€â”€â”˜         â”œâ”€â”€> 2. decreaseStock() âœ…
                         â”œâ”€â”€> 3. pay()          âŒ ì‹¤íŒ¨!
                         â”‚
                         â†“
                    [ë³´ìƒ íŠ¸ëœì­ì…˜ ì‹œì‘]
                         â”‚
                         â”œâ”€â”€> 2. increaseStock() âœ… ì¬ê³  ë³µêµ¬
                         â””â”€â”€> 1. cancelOrder()   âœ… ì£¼ë¬¸ ì·¨ì†Œ


[Choreography Saga - ì´ë²¤íŠ¸ ì²´ì¸]

OrderService:
  createOrder() â†’ OrderCreated ì´ë²¤íŠ¸ ë°œí–‰

StockService:
  OrderCreated ë¦¬ìŠ¤ë‹ â†’ decreaseStock()
  â†’ StockDecreased ì´ë²¤íŠ¸ ë°œí–‰

PaymentService:
  StockDecreased ë¦¬ìŠ¤ë‹ â†’ pay()
  â†’ PaymentFailed ì´ë²¤íŠ¸ ë°œí–‰ (ì‹¤íŒ¨!)

StockService:
  PaymentFailed ë¦¬ìŠ¤ë‹ â†’ increaseStock() (ë³´ìƒ)

OrderService:
  PaymentFailed ë¦¬ìŠ¤ë‹ â†’ cancelOrder() (ë³´ìƒ)
```

#### ì‹¤ë¬´ íŒ¨í„´
- **ëª¨ë†€ë¦¬ì‹**: ë‹¨ì¼ DB íŠ¸ëœì­ì…˜ (`@Transactional`)
- **ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤**: Saga íŒ¨í„´ (Orchestration ë˜ëŠ” Choreography)
- **ë„êµ¬**: Axon Framework, Eventuate, AWS Step Functions

---

## ğŸ“¦ í”„ë¡œì íŠ¸ êµ¬ì¡°

```
order-system/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ main/
â”‚   â”‚   â”œâ”€â”€ java/com/example/order/
â”‚   â”‚   â”‚   â”œâ”€â”€ domain/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ product/
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ entity/
â”‚   â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ Product.java          # @Version (ë‚™ê´€ì  ë½)
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ service/
â”‚   â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ ProductService.java    # ì¬ê³  ê´€ë¦¬
â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ repository/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ order/
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ entity/
â”‚   â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ Order.java             # ì£¼ë¬¸ ì—”í‹°í‹°
â”‚   â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ OrderItem.java         # ì£¼ë¬¸ í•­ëª©
â”‚   â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ OrderStatus.java       # ìƒíƒœ ë¨¸ì‹ 
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ service/
â”‚   â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ OrderService.java      # ì£¼ë¬¸ ë¡œì§
â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ repository/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ payment/
â”‚   â”‚   â”‚   â”‚       â”œâ”€â”€ entity/
â”‚   â”‚   â”‚   â”‚       â”‚   â”œâ”€â”€ Payment.java           # ë©±ë“±ì„± í‚¤
â”‚   â”‚   â”‚   â”‚       â”‚   â””â”€â”€ PaymentStatus.java
â”‚   â”‚   â”‚   â”‚       â”œâ”€â”€ service/
â”‚   â”‚   â”‚   â”‚       â”‚   â””â”€â”€ PaymentService.java    # ê²°ì œ ë¡œì§
â”‚   â”‚   â”‚   â”‚       â””â”€â”€ repository/
â”‚   â”‚   â”‚   â””â”€â”€ global/
â”‚   â”‚   â”‚       â”œâ”€â”€ error/                         # ì˜ˆì™¸ ì²˜ë¦¬
â”‚   â”‚   â”‚       â””â”€â”€ config/                        # ì„¤ì •
â”‚   â”‚   â””â”€â”€ resources/
â”‚   â”‚       â””â”€â”€ application.yml
â”‚   â””â”€â”€ test/
â”‚       â””â”€â”€ java/com/example/order/
â”‚           â”œâ”€â”€ domain/product/service/
â”‚           â”‚   â””â”€â”€ ProductConcurrencyTest.java    # ë™ì‹œì„± í…ŒìŠ¤íŠ¸
â”‚           â”œâ”€â”€ domain/order/service/
â”‚           â”‚   â””â”€â”€ OrderServiceTest.java          # ì£¼ë¬¸ ë¡œì§ í…ŒìŠ¤íŠ¸
â”‚           â””â”€â”€ domain/payment/service/
â”‚               â””â”€â”€ PaymentServiceTest.java        # ë©±ë“±ì„± í…ŒìŠ¤íŠ¸
â”œâ”€â”€ build.gradle
â””â”€â”€ README.md
```

---

## ğŸš€ ì‹¤í–‰ ë°©ë²•

### 1. í”„ë¡œì íŠ¸ í´ë¡  ë° ë¹Œë“œ
```bash
cd /Users/jys/study/example/order-system
./gradlew build
```

### 2. ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰
```bash
./gradlew bootRun
```

### 3. í…ŒìŠ¤íŠ¸ ì‹¤í–‰
```bash
# ì „ì²´ í…ŒìŠ¤íŠ¸
./gradlew test

# íŠ¹ì • í…ŒìŠ¤íŠ¸ë§Œ ì‹¤í–‰
./gradlew test --tests ProductConcurrencyTest
./gradlew test --tests OrderServiceTest
./gradlew test --tests PaymentServiceTest
```

### 4. H2 ì½˜ì†” ì ‘ì†
```
URL: http://localhost:8080/h2-console
JDBC URL: jdbc:h2:mem:testdb
Username: sa
Password: (ë¹„ì–´ìˆìŒ)
```

---

## ğŸ§ª í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤

### 1. ë‚™ê´€ì  ë½ ë™ì‹œì„± í…ŒìŠ¤íŠ¸
```bash
./gradlew test --tests ProductConcurrencyTest

ê²°ê³¼:
- 100ê°œ ë™ì‹œ ìš”ì²­
- ì„±ê³µ: ~70ê°œ (ë¨¼ì € ì»¤ë°‹ëœ íŠ¸ëœì­ì…˜)
- ì‹¤íŒ¨: ~30ê°œ (ë²„ì „ ì¶©ëŒ)
- ìµœì¢… ì¬ê³ : 100 - ì„±ê³µ ìˆ˜ = ì •í™•íˆ ì¼ì¹˜
```

### 2. ì£¼ë¬¸ ìƒíƒœ ì „ì´ í…ŒìŠ¤íŠ¸
```bash
./gradlew test --tests OrderServiceTest

ê²€ì¦:
âœ… CREATED â†’ PAID â†’ SHIPPED â†’ DELIVERED (ì •ìƒ íë¦„)
âœ… CREATED â†’ CANCELLED (ì£¼ë¬¸ ì·¨ì†Œ)
âŒ CREATED â†’ SHIPPED (ê²°ì œ ì—†ì´ ë°°ì†¡ ì‹œë„ - ì˜ˆì™¸)
âŒ DELIVERED â†’ CANCELLED (ë°°ì†¡ ì™„ë£Œ í›„ ì·¨ì†Œ - ì˜ˆì™¸)
```

### 3. ë©±ë“±ì„± í‚¤ í…ŒìŠ¤íŠ¸
```bash
./gradlew test --tests PaymentServiceTest

ê²€ì¦:
âœ… ê°™ì€ idempotencyKeyë¡œ ë‘ ë²ˆ ìš”ì²­ â†’ ê°™ì€ ê²°ì œ ê°ì²´ ë°˜í™˜
âœ… ì´ë¯¸ ê²°ì œëœ ì£¼ë¬¸ ì¬ê²°ì œ ì‹œë„ â†’ ì˜ˆì™¸ ë°œìƒ
```

---

## ğŸ¤ ë©´ì ‘ ì˜ˆìƒ ì§ˆë¬¸ & ë‹µë³€

### Q1. ë‚™ê´€ì  ë½ê³¼ ë¹„ê´€ì  ë½ì˜ ì°¨ì´ëŠ”?

**ë‹µë³€:**
- **ë‚™ê´€ì  ë½**: ì¶©ëŒì´ ì ë‹¤ê³  ê°€ì •í•˜ê³ , ì»¤ë°‹ ì‹œì ì— ë²„ì „(`@Version`)ì„ ì²´í¬í•©ë‹ˆë‹¤. ì½ê¸° ì„±ëŠ¥ì´ ì¢‹ì§€ë§Œ ì¶©ëŒ ì‹œ ì¬ì‹œë„ê°€ í•„ìš”í•©ë‹ˆë‹¤.
- **ë¹„ê´€ì  ë½**: ì½ê¸° ì‹œì ì— DB ë½(`SELECT FOR UPDATE`)ì„ ê±¸ì–´ ì¶©ëŒì„ ì›ì²œ ì°¨ë‹¨í•©ë‹ˆë‹¤. ìˆœì°¨ ì²˜ë¦¬ë¡œ ëŠë¦¬ì§€ë§Œ 100% ì„±ê³µì„ ë³´ì¥í•©ë‹ˆë‹¤.

**ì‹¤ë¬´ ì ìš©:**
- ì¼ë°˜ ì‡¼í•‘ëª° ì¬ê³  â†’ ë‚™ê´€ì  ë½
- ì„ ì°©ìˆœ ì¿ í°, í‹°ì¼“íŒ… â†’ ë¹„ê´€ì  ë½

---

### Q2. ë©±ë“±ì„±(Idempotency)ì´ ì™œ ì¤‘ìš”í•œê°€ìš”?

**ë‹µë³€:**
ë„¤íŠ¸ì›Œí¬ íƒ€ì„ì•„ì›ƒì´ë‚˜ í´ë¼ì´ì–¸íŠ¸ ì¬ì‹œë„ë¡œ ì¸í•œ **ì¤‘ë³µ ìš”ì²­**ì„ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬í•˜ê¸° ìœ„í•´ í•„ìš”í•©ë‹ˆë‹¤.

**ì‹œë‚˜ë¦¬ì˜¤:**
1. ì‚¬ìš©ìê°€ ê²°ì œ ë²„íŠ¼ í´ë¦­
2. ì„œë²„ì—ì„œ ì²˜ë¦¬ ì¤‘ ë„¤íŠ¸ì›Œí¬ íƒ€ì„ì•„ì›ƒ
3. í´ë¼ì´ì–¸íŠ¸ê°€ ì‘ë‹µì„ ëª» ë°›ì•„ ìë™ ì¬ì‹œë„
4. ë©±ë“±ì„± í‚¤ê°€ ì—†ìœ¼ë©´ â†’ ì¤‘ë³µ ê²°ì œ ë°œìƒ!
5. ë©±ë“±ì„± í‚¤ê°€ ìˆìœ¼ë©´ â†’ ê°™ì€ í‚¤ ê°ì§€, ê¸°ì¡´ ê²°ì œ ë°˜í™˜

**ì‹¤ë¬´:**
- ì¹´ì¹´ì˜¤í˜ì´, í† ìŠ¤, ìŠ¤íŠ¸ë¼ì´í”„ ë“± ëª¨ë“  ê²°ì œ APIê°€ ë©±ë“±ì„± í‚¤ë¥¼ ìš”êµ¬í•©ë‹ˆë‹¤.

---

### Q3. ì´ë²¤íŠ¸ ê¸°ë°˜ ì•„í‚¤í…ì²˜ì˜ ì¥ë‹¨ì ì€?

**ë‹µë³€:**

**ì¥ì :**
- **ëŠìŠ¨í•œ ê²°í•©**: ì„œë¹„ìŠ¤ ê°„ ì§ì ‘ ì˜ì¡´ì„± ì œê±°
- **í™•ì¥ ìš©ì´**: ìƒˆë¡œìš´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ê°€ ê°„ë‹¨
- **ë¹„ë™ê¸° ì²˜ë¦¬**: ì‘ë‹µ ì†ë„ ê°œì„  (ì´ë©”ì¼, ì•Œë¦¼ ë“±)

**ë‹¨ì :**
- **ë””ë²„ê¹… ì–´ë ¤ì›€**: ì´ë²¤íŠ¸ íë¦„ ì¶”ì ì´ ë³µì¡
- **íŠ¸ëœì­ì…˜ ê´€ë¦¬**: ì´ë²¤íŠ¸ ì‹¤íŒ¨ ì‹œ ë³´ìƒ ë¡œì§ í•„ìš”
- **ìˆœì„œ ë³´ì¥**: ë©”ì‹œì§€ ìˆœì„œ ì²˜ë¦¬ê°€ ì–´ë ¤ì›€

**ì‹¤ë¬´:**
- ê°œë°œ: Spring ApplicationEvent
- ìš´ì˜: Kafka, RabbitMQ (ë©”ì‹œì§€ ë³´ì¥, ì¬ì²˜ë¦¬)

---

### Q4. ë³´ìƒ íŠ¸ëœì­ì…˜(Compensation Transaction)ì´ë€?

**ë‹µë³€:**
ì´ë¯¸ ì‹¤í–‰ëœ ì‘ì—…ì„ **ë˜ëŒë¦¬ëŠ”** íŠ¸ëœì­ì…˜ì…ë‹ˆë‹¤.

**ì˜ˆì‹œ:**
- ì£¼ë¬¸ ìƒì„± ì‹œ ì¬ê³  ì°¨ê° â†’ ì£¼ë¬¸ ì·¨ì†Œ ì‹œ ì¬ê³  ë³µêµ¬

**ë¶„ì‚° ì‹œìŠ¤í…œ:**
- **Saga íŒ¨í„´**: ì—¬ëŸ¬ ì„œë¹„ìŠ¤ì— ê±¸ì¹œ íŠ¸ëœì­ì…˜ì„ ê´€ë¦¬
- **Orchestration**: ì¤‘ì•™ ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´í„°ê°€ ìˆœì„œ ì œì–´
- **Choreography**: ê° ì„œë¹„ìŠ¤ê°€ ì´ë²¤íŠ¸ë¥¼ í†µí•´ í˜‘ë ¥

**ì‹¤ë¬´ ë„êµ¬:**
- Axon Framework, Eventuate, AWS Step Functions

---

### Q5. ì£¼ë¬¸ ì‹œìŠ¤í…œì—ì„œ ë™ì‹œì„± ë¬¸ì œë¥¼ ì–´ë–»ê²Œ í•´ê²°í•˜ë‚˜ìš”?

**ë‹µë³€:**

**ì¬ê³  ì°¨ê°:**
- ë‚™ê´€ì  ë½ (`@Version`) ì‚¬ìš©
- ì¶©ëŒ ì‹œ ì¬ì‹œë„ ë¡œì§ êµ¬í˜„ (ìµœëŒ€ 3íšŒ)

**ì¤‘ë³µ ê²°ì œ ë°©ì§€:**
- ë©±ë“±ì„± í‚¤ (`idempotencyKey`) ì‚¬ìš©
- DB UNIQUE ì œì•½ ì¡°ê±´ìœ¼ë¡œ ë³´ì¥

**ì£¼ë¬¸ ìƒíƒœ ê´€ë¦¬:**
- ìƒíƒœ ë¨¸ì‹  íŒ¨í„´ìœ¼ë¡œ ì˜ëª»ëœ ì „ì´ ì°¨ë‹¨
- ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì—ì„œ ìƒíƒœ ê²€ì¦

**ì´ë²¤íŠ¸ ì²˜ë¦¬:**
- ë¹„ë™ê¸° ì´ë²¤íŠ¸ë¡œ ì‘ë‹µ ì†ë„ ê°œì„ 
- ì‹¤íŒ¨ ì‹œ ì¬ì²˜ë¦¬ í (Dead Letter Queue)

---

### Q6. @Versionì€ ì–´ë–»ê²Œ ë™ì‘í•˜ë‚˜ìš”?

**ë‹µë³€:**
```sql
-- ì½ê¸°
SELECT id, stock, version FROM product WHERE id = 1;
-- ê²°ê³¼: stock=100, version=1

-- ìˆ˜ì •
UPDATE product
SET stock = 90, version = 2
WHERE id = 1 AND version = 1;

-- ë‹¤ë¥¸ íŠ¸ëœì­ì…˜ì´ ë¨¼ì € ìˆ˜ì •í–ˆë‹¤ë©´?
UPDATE product
SET stock = 90, version = 2
WHERE id = 1 AND version = 1;  -- version=2ë¡œ ì´ë¯¸ ë³€ê²½ë¨
-- â†’ 0 rows updated â†’ OptimisticLockingFailureException
```

JPAê°€ ìë™ìœ¼ë¡œ `WHERE version = ?` ì¡°ê±´ì„ ì¶”ê°€í•˜ì—¬ ë™ì‹œì„±ì„ ì œì–´í•©ë‹ˆë‹¤.

---

### Q7. ì‹¤ì œ ì„œë¹„ìŠ¤ì—ì„œ ì¬ì‹œë„ ë¡œì§ì€ ì–´ë–»ê²Œ êµ¬í˜„í•˜ë‚˜ìš”?

**ë‹µë³€:**
```java
@Retryable(
    value = {ObjectOptimisticLockingFailureException.class},
    maxAttempts = 3,
    backoff = @Backoff(delay = 100)
)
public void decreaseStock(Long productId, int quantity) {
    Product product = productRepository.findById(productId)
        .orElseThrow(...);
    product.decreaseStock(quantity);
}
```

**ì‹¤ë¬´ íŒ:**
- Spring Retry ë˜ëŠ” Resilience4j ì‚¬ìš©
- ì§€ìˆ˜ ë°±ì˜¤í”„(Exponential Backoff) ì ìš©
- ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜ ì œí•œ (3~5íšŒ)
- ì¬ì‹œë„ ì‹¤íŒ¨ ì‹œ ì•Œë¦¼ ë°œì†¡

---

## ğŸ“š ì°¸ê³  ìë£Œ

- [Spring Data JPA ê³µì‹ ë¬¸ì„œ - Locking](https://docs.spring.io/spring-data/jpa/docs/current/reference/html/#jpa.locking)
- [Saga íŒ¨í„´ - Chris Richardson](https://microservices.io/patterns/data/saga.html)
- [Idempotency - Stripe API](https://stripe.com/docs/api/idempotent_requests)
- [í† ìŠ¤ ê²°ì œ ë©±ë“±ì„± ê°€ì´ë“œ](https://docs.tosspayments.com/guides/idempotency)

---

## ğŸ“ ë¼ì´ì„ ìŠ¤

This project is for educational purposes only.

---

## âœ‰ï¸ ë¬¸ì˜

í”„ë¡œì íŠ¸ ê´€ë ¨ ë¬¸ì˜ì‚¬í•­ì´ë‚˜ ê°œì„  ì œì•ˆì€ ì´ìŠˆë¡œ ë“±ë¡í•´ì£¼ì„¸ìš”.
